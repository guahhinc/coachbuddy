<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coachbuddy</title>
    <style>
        /* CRITICAL FIX: Ensure padding and borders do not expand element size beyond 100% */
        * {
            box-sizing: border-box;
        }
        
        html {
            height: 100%;
        }

        /* Base and Mobile-First Styling */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212; /* Dark background for modern look */
            color: #E0E0E0;
            height: 100%; 
            overflow-x: hidden; 
            overflow-y: auto; 
            
            font-size: 13px; /* Base font size increased */
            
            /* --- ADD HUGE TOP PADDING FOR SCROLL BUFFER --- */
            padding-top: 50vh;
        }
        
        /* Center content and apply background to the main area */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%; 
            height: auto;
            /* FIX: Push content up to counteract body's top padding, keeping content aligned at the top */
            margin-top: -50vh;
        }

        /* Container to center content on larger screens */
        .app-container {
            width: 100%;
            max-width: 480px;
            padding: 8px 6px;
        }

        /* --- SECTION BASE STYLES --- */
        #timer-section, #input-section, #roster, #notes-section, #team-name-section {
            background-color: #1E1E1E;
            padding: 8px;
            border-radius: 6px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            margin-bottom: 10px;
        }
        
        /* --- TEAM NAME/NOTES SECTION STYLES --- */
        #notes-section, #team-name-section {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            margin-top: 0; 
            margin-bottom: 10px;
        }
        #game-notes, #team-name-input { 
            padding: 7px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 16px; 
            background-color: #2D2D2D;
            color: #E0E0E0;
            width: 100%; 
            box-sizing: border-box;
        }
        #game-notes {
            min-height: 80px;
            resize: vertical;
        }


        /* --- TIMER SECTION STYLES --- */
        #timer-section {
            text-align: center;
        }
        #time-display {
            font-size: 2.7rem;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        #time-display.countdown-ended {
             color: #D32F2F;
        }
        .timer-controls {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 6px;
        }
        .timer-controls.adjust-controls {
            margin-top: 4px;
        }
        .timer-btn {
            padding: 7px 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            flex-grow: 1; 
            min-width: 65px;
            font-size: 13px;
            line-height: 1.2;
        }
        .timer-btn.primary {
            background-color: #007bff;
            color: white;
        }
        .timer-btn.primary.pause {
            background-color: #FF9800;
        }
        .timer-btn.secondary, .timer-btn.mode-btn {
            background-color: #424242;
            color: #E0E0E0;
        }
        .timer-btn.secondary:hover, .timer-btn.mode-btn:hover {
            background-color: #555;
        }
        
        /* --- PLAYER INPUT SECTION STYLES --- */
        #input-section {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        #player-number-input, #player-name {
            padding: 7px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 16px; 
            background-color: #2D2D2D;
            color: #E0E0E0;
        }
        #player-number-input {
            width: 45px; 
            flex-shrink: 0;
            text-align: center;
        }
        #player-name {
            flex-grow: 1;
        }

        /* Style for the green plus icon button */
        .add-icon-btn {
            background-color: #4CAF50;
            color: white;
            width: 32px;
            height: 32px;
            font-size: 19px; 
            line-height: 32px;
            padding: 0;
            border-radius: 4px;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* --- PLAYER ROSTER STYLES --- */
        #roster {
            overflow: hidden;
            margin-bottom: 10px;
        }
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px; 
            border-bottom: 1px solid #333;
        }
        .player-info-group {
            display: flex;
            align-items: center;
            gap: 6px; 
            flex-grow: 1;
            padding-right: 8px;
        }
        
        /* UPDATED: Player Rank Styling for Dense Ranking - Rank 3+ default */
        .player-rank {
            font-weight: 700;
            color: white; /* Default text color (for rank 3+) */
            background-color: #424242; /* Default dark gray background (for rank 3+) */
            font-size: 14px;
            width: 28px; 
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 4px;
            flex-shrink: 0;
            margin-right: 4px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Rank 1: RED */
        .player-rank.rank-color-1 {
            background-color: #D32F2F; 
            color: white; 
        }

        /* Rank 2: YELLOW */
        .player-rank.rank-color-2 {
            background-color: #FFC107; 
            color: #121212; /* Dark text for visibility on Yellow */
        }
        
        .player-number {
            font-weight: 700;
            color: #64B5F6; 
            font-size: 15px;
            flex-shrink: 0;
            white-space: nowrap; 
        }
        .player-name {
            font-weight: 500;
            font-size: 15px; 
            word-break: break-word;
        }
        .warning-icon {
            font-size: 16px;
            margin-left: 5px;
            display: none; 
        }
        .warning-icon.low {
            color: #FFC107;
        }
        .player-time {
            font-weight: bold;
            color: #64B5F6;
            font-size: 15px; 
            min-width: 50px;
            text-align: right;
            flex-shrink: 0;
        }
        .player-controls-group {
            display: flex;
            align-items: center;
            gap: 8px; 
            flex-shrink: 0;
        }
        .toggle-btn {
            padding: 5px 8px;
            width: 48px;
            font-size: 13px;
            border-radius: 4px;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .toggle-btn.status-on {
            background-color: #4CAF50;
            color: white;
        }
        .toggle-btn.status-off {
            background-color: #D32F2F;
            color: white;
        }
        .delete-btn {
            width: 24px;
            height: 24px;
            font-size: 13px;
            line-height: 1;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #424242;
            color: white;
        }

        
        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1E1E1E;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
            text-align: left;
        }
        #modal-title {
            font-size: 1.3rem;
            margin-top: 0;
            color: #E0E0E0;
            text-align: center;
        }
        #modal-message {
            margin-bottom: 20px;
            color: #B0B0B0;
            font-size: 14px; 
            white-space: pre-line;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-around;
            text-align: center; 
        }
        .modal-buttons .timer-btn {
            flex-basis: 50%;
            padding: 8px 15px;
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="app-container">
            
            <!-- TEAM NAME SECTION -->
            <div id="team-name-section">
                <label for="team-name-input" style="display:block; margin-bottom: 5px; font-weight: bold;">Team Name:</label>
                <input type="text" id="team-name-input" placeholder="Enter Team Name (Required)">
            </div>
            <!-- END TEAM NAME SECTION -->
            
            <!-- TIMER SECTION -->
            <div id="timer-section">
                <div id="time-display">00:00</div>
                <div class="timer-controls mode-main-controls">
                    <button id="mode-toggle-btn" class="timer-btn mode-btn">Countdown</button>
                    <button id="start-pause-btn" class="timer-btn primary">Start</button>
                    <button id="reset-btn" class="timer-btn secondary">Reset</button>
                </div>
                <div class="timer-controls adjust-controls">
                    <button id="add-minute-btn" class="timer-btn secondary">+1 Min</button>
                    <button id="subtract-minute-btn" class="timer-btn secondary">–1 Min</button>
                </div>
            </div>
      
            <!-- PLAYER INPUT SECTION -->
            <div id="input-section">
                <input type="text" id="player-number-input" placeholder="No."> 
                <input type="text" id="player-name" placeholder="Enter player's name">
                <button id="add-player-btn" class="add-icon-btn">+</button>
            </div>
            <!-- END PLAYER INPUT SECTION -->
            
            <!-- PLAYER ROSTER -->
            <div id="roster">
                <!-- Player items will be added here by JavaScript -->
            </div>
            <!-- END ROSTER SECTION -->

            <!-- NOTES SECTION -->
            <div id="notes-section">
                <label for="game-notes" style="display:block; margin-bottom: 5px; font-weight: bold;">Notes:</label>
                <textarea id="game-notes" placeholder="Add game notes here..."></textarea>
            </div>
            <!-- END NOTES SECTION -->

            
            <!-- ACTION BUTTONS -->
            <div class="timer-controls" style="margin-top: 10px;">
                <button id="save-to-sheets-btn" class="timer-btn primary" style="flex-grow: unset; width: 100%; background-color: #1a73e8;">Finish Game</button>
            </div>
            <div class="timer-controls" style="margin-top: 5px;"> 
                <button id="suggest-sub-btn" class="timer-btn secondary" style="flex-grow: unset; width: 100%;">Substitute Suggestion</button>
            </div>
            <div class="timer-controls" style="margin-top: 5px;">
                <button id="add-default-players-btn" class="timer-btn secondary" style="flex-grow: unset; width: 100%;">Add Default Players</button>
            </div>

        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="timer-btn secondary">Cancel</button>
                <button id="modal-confirm-btn" class="timer-btn primary">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const MAX_PLAYERS_ON_FIELD = 5;
        const MIN_GAME_TIME_FOR_WARNINGS = 180;
        const LOW_TIME_RATIO = 0.65;
        const LOW_TIME_DIFFERENCE_THRESHOLD = 30;
        const INITIAL_STOPWATCH_SECONDS = 0;
        const DEFAULT_COUNTDOWN_SECONDS = 2400; // 40 minutes
        const LOCAL_STORAGE_KEY = 'coachbuddyTeamName'; // Key for browser storage

        // 🔥 CRITICAL FIX: NEW SCRIPT URL PROVIDED BY USER
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw7Xa1_PWR2jhYdIYimi460fxJYuyY_ffIx7IcG0ys3pX-FoCMScZT3ABdLIyD0YuZ9fg/exec';
        
        // --- TIMER STATE ---
        let countdownInterval = null, totalSeconds = INITIAL_STOPWATCH_SECONDS, isRunning = false, isCountdownMode = false;

        // --- UTILITY FUNCTION ---
        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }
        
        // --- DOM ELEMENTS ---
        const timeDisplay = document.getElementById('time-display');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const modeToggleBtn = document.getElementById('mode-toggle-btn');
        const addMinuteBtn = document.getElementById('add-minute-btn');
        const subtractMinuteBtn = document.getElementById('subtract-minute-btn');
        const playerNumberInput = document.getElementById('player-number-input');
        const playerNameInput = document.getElementById('player-name');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const rosterDiv = document.getElementById('roster');
        const suggestSubBtn = document.getElementById('suggest-sub-btn');
        const addDefaultPlayersBtn = document.getElementById('add-default-players-btn');
        const saveToSheetsBtn = document.getElementById('save-to-sheets-btn');
        const teamNameInput = document.getElementById('team-name-input'); 

        // --- INITIALIZATION: Load saved team name ---
        function loadTeamName() {
            const savedName = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedName) {
                teamNameInput.value = savedName;
            }
        }
        // Save the team name to local storage whenever the input changes
        teamNameInput.addEventListener('input', () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, teamNameInput.value.trim());
        });
        window.addEventListener('load', loadTeamName);
        

        // --- MODAL LOGIC (UNTOUCHED) ---
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let confirmationCallback = null;
        function resetModalButtons() {
            modalConfirmBtn.textContent = 'Confirm';
            modalCancelBtn.style.display = 'inline-block';
        }

        function showConfirmation(title, message, callback) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmationCallback = callback;
            customModal.style.display = 'flex';
        }

        modalConfirmBtn.onclick = () => {
            if (confirmationCallback) confirmationCallback(true);
            customModal.style.display = 'none';
            confirmationCallback = null;
            resetModalButtons();
        };

        modalCancelBtn.onclick = () => {
            if (confirmationCallback) confirmationCallback(false);
            customModal.style.display = 'none';
            confirmationCallback = null;
            resetModalButtons();
        };


        // --- PLAYER ROSTER LOGIC (RANK REVERSED FOR PRIORITY) ---

        function createPlayerItem(name, number = null) {
            const playerItem = document.createElement('div');
            playerItem.className = 'player-item';
            playerItem.dataset.totalTime = 0;
            playerItem.dataset.isOnField = '0';
            playerItem.dataset.rank = '0'; 

            const playerInfoGroup = document.createElement('div');
            playerInfoGroup.className = 'player-info-group';

            // Rank Display Element
            const playerRankDisplay = document.createElement('span');
            playerRankDisplay.className = 'player-rank';
            playerRankDisplay.textContent = '-'; 
            playerRankDisplay.dataset.role = 'player-rank-display';
            playerInfoGroup.appendChild(playerRankDisplay);

            if (number !== null) {
                const playerNumber = document.createElement('span');
                playerNumber.className = 'player-number';
                playerNumber.textContent = `#${number}`; 
                playerInfoGroup.appendChild(playerNumber);
            }

            const playerName = document.createElement('span');
            playerName.className = 'player-name';
            playerName.textContent = name;
            playerInfoGroup.appendChild(playerName);
            
            const lowWarningIcon = document.createElement('span');
            lowWarningIcon.className = 'warning-icon low';
            lowWarningIcon.textContent = '⚠️';
            lowWarningIcon.title = 'Low play time - Consider subbing on';
            lowWarningIcon.dataset.role = 'low-warning-icon';
            playerInfoGroup.appendChild(lowWarningIcon); 

            const playerControlsGroup = document.createElement('div');
            playerControlsGroup.className = 'player-controls-group';
            const timeOnFieldDisplay = document.createElement('span');
            timeOnFieldDisplay.className = 'player-time';
            timeOnFieldDisplay.textContent = formatTime(0);

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-btn status-off';
            toggleBtn.textContent = 'ON';
            
            toggleBtn.onclick = () => {
                const isOn = playerItem.dataset.isOnField === '1';
                if (isOn) {
                    playerItem.dataset.isOnField = '0';
                    toggleBtn.textContent = 'ON';
                    toggleBtn.classList.add('status-off');
                    toggleBtn.classList.remove('status-on');
                } else {
                    const currentOnCount = document.querySelectorAll('.player-item[data-is-on-field="1"]').length;
                    if (currentOnCount >= MAX_PLAYERS_ON_FIELD) {
                        showConfirmation(
                            'Substitution Limit Reached',
                            `Cannot sub this player ON. You currently have the maximum of ${MAX_PLAYERS_ON_FIELD} players on the field. Please sub a player OFF first.`,
                            (confirmed) => {}
                        );
                        modalConfirmBtn.textContent = 'OK';
                        modalCancelBtn.style.display = 'none';
                        return;
                    }
                    playerItem.dataset.isOnField = '1';
                    toggleBtn.textContent = 'OFF';
                    toggleBtn.classList.remove('status-off');
                    toggleBtn.classList.add('status-on');

                    const lowIcon = playerItem.querySelector('[data-role="low-warning-icon"]');
                    if (lowIcon) lowIcon.style.display = 'none';
                }
                updateSubstitutionWarnings();
            };
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '×';
            deleteBtn.title = 'Remove Player';
            deleteBtn.onclick = () => {
                showConfirmation(
                    'Remove Player',
                    `Are you sure you want to remove ${name}? Their accumulated time will be lost.`,
                    (confirmed) => {
                        if (confirmed) {
                            rosterDiv.removeChild(playerItem);
                            updateSubstitutionWarnings();
                        }
                    }
                );
            };

            playerControlsGroup.appendChild(timeOnFieldDisplay);
            playerControlsGroup.appendChild(toggleBtn);
            playerControlsGroup.appendChild(deleteBtn);
            
            playerItem.appendChild(playerInfoGroup);
            playerItem.appendChild(playerControlsGroup);

            return playerItem;
        }
        
        function addPlayerByName(name, number = null) {
            const effectiveName = name || (number !== null ? `Player #${number}` : 'Unnamed Player');
            const newPlayerItem = createPlayerItem(effectiveName, number); 
            rosterDiv.appendChild(newPlayerItem);
            updateSubstitutionWarnings();
        }

        function addPlayerFromInput() {
            const name = playerNameInput.value.trim();
            const numberStr = playerNumberInput.value.trim();
            const number = numberStr && !isNaN(parseInt(numberStr)) ? parseInt(numberStr) : null;
            if (name || number !== null) { 
                addPlayerByName(name, number);
                playerNameInput.value = '';
                playerNumberInput.value = '';
                playerNameInput.focus();
                
                setTimeout(() => { window.scrollTo(0, 0); }, 200);
            } else {
                console.log('Player name and number cannot both be empty.');
            }
        }

        addPlayerBtn.addEventListener('click', addPlayerFromInput);
        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPlayerFromInput();
        });
        playerNumberInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addPlayerFromInput();
        });
        
        const DEFAULT_PLAYERS = [
            { name: 'Ava', number: 6 }, 
            { name: 'Maddie', number: 32 }, 
            { name: 'AK', number: 52 }, 
            { name: 'Indigo', number: 50 }, 
            { name: 'Aria', number: 7 }, 
            { name: 'London', number: 8 }
        ];

        addDefaultPlayersBtn.addEventListener('click', () => {
            showConfirmation(
                'Add Default Players',
                'Are you sure you want to add the default roster? This will not remove existing players.',
                (confirmed) => {
                    if (confirmed) {
                        DEFAULT_PLAYERS.forEach(player => addPlayerByName(player.name, player.number));
                    }
                }
            );
        });

        function suggestSubstitution() {
            const playerItems = document.querySelectorAll('.player-item');
            if (playerItems.length === 0) {
                showConfirmation('Suggestion Unavailable', 'Please add players to the roster first.', (c) => {});
                modalConfirmBtn.textContent = 'OK';
                modalCancelBtn.style.display = 'none';
                return;
            }

            const players = Array.from(playerItems).map(item => {
                const time = parseInt(item.dataset.totalTime);
                const isOnField = item.dataset.isOnField === '1';
                const nameElement = item.querySelector('.player-name');
                const numberElement = item.querySelector('.player-number');
                let displayName = nameElement ? nameElement.textContent : 'Unnamed Player';
                if (numberElement) displayName = `${numberElement.textContent} ${displayName}`;
                return { element: item, time, isOnField, name: displayName };
            });
            
            // Player to TAKE OFF: Highest total time (Rank 1). Sort descending.
            const onFieldPlayers = players.filter(p => p.isOnField).sort((a, b) => b.time - a.time);
            
            // Player to SUB ON: Lowest total time. Sort ascending.
            const offFieldPlayers = players.filter(p => !p.isOnField).sort((a, b) => a.time - b.time);
            
            let message = '';
            if (onFieldPlayers.length > 0 && offFieldPlayers.length > 0) {
                const playerToTakeOff = onFieldPlayers[0];
                const playerToSubOn = offFieldPlayers[0];
                message = `Based on current time balance, here is the suggested substitution:\n\n` +
                          `\u25b6 Take OFF (Highest Time): ${playerToTakeOff.name} (${formatTime(playerToTakeOff.time)})\n` +
                          `\u25c0 Sub ON (Lowest Time): ${playerToSubOn.name} (${formatTime(playerToSubOn.time)})`;
            } else {
                message = onFieldPlayers.length === 0 ?
                'There are no players currently on the field to substitute off.'
                : 'There are no players currently off the field to substitute on.';
            }
            showConfirmation('Substitution Suggestion', message, (c) => {});
            modalConfirmBtn.textContent = 'OK';
            modalCancelBtn.style.display = 'none';
        }
        suggestSubBtn.addEventListener('click', suggestSubstitution);

        function updateSubstitutionWarnings() {
            const playerItems = document.querySelectorAll('.player-item');
            if (playerItems.length === 0) return;

            let totalTimeSum = 0, totalOnFieldTimeSum = 0, playersOnFieldCount = 0;
            
            // 1. Collect data and calculate sums
            const playerArray = Array.from(playerItems).map(item => {
                const playerTime = parseInt(item.dataset.totalTime);
                totalTimeSum += playerTime;
                if (item.dataset.isOnField === '1') {
                    totalOnFieldTimeSum += playerTime;
                    playersOnFieldCount++;
                }
                return { element: item, time: playerTime };
            });

            // 2. Rank Logic: Sort by descending time (most time = Rank 1)
            const sortedPlayers = [...playerArray].sort((a, b) => b.time - a.time); // DESCENDING sort

            // Implement Dense Ranking (1, 1, 2, 2, 3, ...)
            let denseRank = 0; // The actual rank to display (starts at 0 before first player)
            let previousTime = -1; // Time of the previous player
            
            sortedPlayers.forEach((player) => { 
                const playerElement = player.element;
                const rankDisplay = playerElement.querySelector('[data-role="player-rank-display"]');
                
                // If the time has changed (i.e., this player is worse than the previous one)
                if (player.time !== previousTime) {
                    denseRank++; // Move to the next rank number (1 -> 2 -> 3)
                }
                previousTime = player.time; // Update previous time for the next iteration

                // Store and display the rank
                playerElement.dataset.rank = denseRank;
                
                if (rankDisplay) {
                    rankDisplay.textContent = denseRank;
                    // Reset class list
                    rankDisplay.classList.remove('rank-color-1', 'rank-color-2');
                    
                    // Apply color based on rank
                    if (denseRank === 1) {
                        rankDisplay.classList.add('rank-color-1'); // Red
                    } else if (denseRank === 2) {
                        rankDisplay.classList.add('rank-color-2'); // Yellow
                    } 
                    // Rank 3+ defaults to the base .player-rank style (Dark Gray/White)
                }
            });
            
            // 3. Low Time Warning Logic
            if (playerArray.length < 2 || totalSeconds < MIN_GAME_TIME_FOR_WARNINGS || totalTimeSum === 0) {
                 playerItems.forEach(item => {
                    const lowIcon = item.querySelector('[data-role="low-warning-icon"]');
                    if (lowIcon) lowIcon.style.display = 'none';
                 });
                 return;
            }

            const lowTimeAverage = playersOnFieldCount > 0 ? totalOnFieldTimeSum / playersOnFieldCount : 0;
            playerItems.forEach(item => {
                const playerTime = parseInt(item.dataset.totalTime);
                const lowIcon = item.querySelector('[data-role="low-warning-icon"]');
                const isOnField = item.dataset.isOnField === '1';
                if (lowIcon) lowIcon.style.display = 'none';
              
                if (lowIcon && !isOnField && lowTimeAverage > 0) {
                    // Check if the off-field player is significantly behind the average on-field time
                    const isRatioLow = playerTime < lowTimeAverage * LOW_TIME_RATIO;
                    const isDifferenceMeaningful = (lowTimeAverage - playerTime) >= LOW_TIME_DIFFERENCE_THRESHOLD;
                    if (isRatioLow && isDifferenceMeaningful) lowIcon.style.display = 'inline';
                }
            });
        }
        
        // --- TIMER LOGIC (UNTOUCHED) ---
        function startTimer() {
            if (isRunning || (isCountdownMode && totalSeconds <= 0)) return;
            isRunning = true;
            startPauseBtn.textContent = 'Pause';
            startPauseBtn.classList.add('pause');

            countdownInterval = setInterval(() => {
                if (isCountdownMode) {
                    if (totalSeconds > 0) totalSeconds--;
                    else {
                        clearInterval(countdownInterval);
                        isRunning = false;
                        startPauseBtn.textContent = 'Done!';
                        startPauseBtn.classList.remove('pause');
                        timeDisplay.classList.add('countdown-ended');
                    }
                } else totalSeconds++;
                
                timeDisplay.textContent = formatTime(totalSeconds);
                timeDisplay.classList.toggle('countdown-ended', isCountdownMode && totalSeconds <= 60 && totalSeconds > 0);

                document.querySelectorAll('.player-item').forEach(item => {
                    if (isRunning && item.dataset.isOnField === '1') {
                        let currentTime = parseInt(item.dataset.totalTime) + 1;
                        item.dataset.totalTime = currentTime;
                        item.querySelector('.player-time').textContent = formatTime(currentTime);
                    }
                });
                updateSubstitutionWarnings();
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(countdownInterval);
            isRunning = false;
            startPauseBtn.textContent = 'Resume';
            startPauseBtn.classList.remove('pause');
        }

        function resetTimer() {
            clearInterval(countdownInterval);
            isRunning = false;
            startPauseBtn.textContent = 'Start';
            startPauseBtn.classList.remove('pause');
            timeDisplay.classList.remove('countdown-ended');
            totalSeconds = isCountdownMode ? DEFAULT_COUNTDOWN_SECONDS : INITIAL_STOPWATCH_SECONDS;
            timeDisplay.textContent = formatTime(totalSeconds);
            
            // Reset player data
            document.querySelectorAll('.player-item').forEach(item => {
                item.dataset.totalTime = 0;
                item.querySelector('.player-time').textContent = formatTime(0);
                item.dataset.isOnField = '0'; 
                const toggleBtn = item.querySelector('.toggle-btn');
                if(toggleBtn) {
                     toggleBtn.textContent = 'ON';
                     toggleBtn.classList.add('status-off');
                     toggleBtn.classList.remove('status-on');
                }
            });
            updateSubstitutionWarnings();
        }
        
        function adjustTime(seconds) {
            totalSeconds = Math.max(0, totalSeconds + seconds);
            timeDisplay.textContent = formatTime(totalSeconds);
            if (isCountdownMode && totalSeconds === 0 && isRunning) {
                clearInterval(countdownInterval);
                isRunning = false;
                startPauseBtn.textContent = 'Done!';
                startPauseBtn.classList.add('countdown-ended');
            }
            updateSubstitutionWarnings();
        }

        function toggleMode() {
            const newMode = isCountdownMode ? 'Stopwatch' : 'Countdown';
            showConfirmation(
                'Confirm Mode Switch',
                `Are you sure you want to switch to ${newMode} mode? This will reset the main timer and all player times.`,
                (confirmed) => {
                    if (confirmed) {
                        isCountdownMode = !isCountdownMode;
                        modeToggleBtn.textContent = isCountdownMode ? 'Stopwatch' : 'Countdown';
                        resetTimer();
                    }
                }
            );
        }

        startPauseBtn.addEventListener('click', () => isRunning ? pauseTimer() : startTimer());
        resetBtn.addEventListener('click', () => {
            showConfirmation(
                'Confirm Timer Reset',
                'Are you sure you want to reset the main timer and all player times to zero?',
                (confirmed) => { if (confirmed) resetTimer(); }
            );
        });
        modeToggleBtn.addEventListener('click', toggleMode);
        addMinuteBtn.addEventListener('click', () => adjustTime(60));
        subtractMinuteBtn.addEventListener('click', () => adjustTime(-60));
        timeDisplay.textContent = formatTime(INITIAL_STOPWATCH_SECONDS);


        // --- GOOGLE SHEETS INTEGRATION (RANK REMAINS REMOVED from payload) ---
        function collectGameData() {
            const teamName = teamNameInput.value.trim() || ''; 
            const mainTime = document.getElementById('time-display').textContent;
            const gameNotes = document.getElementById('game-notes').value;
            const players = [];
            
            document.querySelectorAll('.player-item').forEach(item => {
                players.push({
                    // Rank is INTENTIONALLY NOT included in the payload sent to Google Sheets
                    number: item.querySelector('.player-number')?.textContent.replace('#', '') || 'N/A', 
                    name: item.querySelector('.player-name')?.textContent || 'Unnamed',
                    time: item.querySelector('.player-time')?.textContent || '00:00'
                });
            });
            return {
                teamName: teamName,
                gameDate: new Date().toLocaleString(),
                mainTime: mainTime,
                players: players,
                notes: gameNotes
            };
        }

        function sendDataToSheets() {
            const gameData = collectGameData();
            
            // *** VALIDATION CHECK ***
            if (!gameData.teamName) {
                showConfirmation('Required Field Missing', 'Please enter a **Team Name** before saving the game data.', () => {});
                modalConfirmBtn.textContent = 'OK';
                modalCancelBtn.style.display = 'none';
                return;
            }

            saveToSheetsBtn.disabled = true;
            saveToSheetsBtn.textContent = 'Saving...';

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(gameData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showConfirmation('Success!', `Game data was saved to the sheet: "${gameData.teamName || 'Game Log'}".`, () => {});
                } else {
                    showConfirmation('Error', `An error occurred: ${data.message || 'Unknown error.'}`, () => {});
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showConfirmation('Network Error', `A network error occurred. Ensure the script URL is correct and you have an internet connection. Details: ${error}`, () => {});
            })
            .finally(() => {
                saveToSheetsBtn.disabled = false;
                saveToSheetsBtn.textContent = 'Finish Game';
                modalConfirmBtn.textContent = 'OK';
                modalCancelBtn.style.display = 'none';
            });
        }
        
        saveToSheetsBtn.addEventListener('click', () => {
            showConfirmation(
                'Finish and Save Game',
                'Are you sure you want to end this game session? The final times will be saved to your Google Sheet.',
                (confirmed) => {
                    if (confirmed) {
                        sendDataToSheets();
                    }
                }
            );
        });

    </script>
</body>
</html>
